<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>MIT 6.824 Lab2 - trs的个人博客</title><meta name="Description" content="只是平凡记录着"><meta property="og:title" content="MIT 6.824 Lab2" />
<meta property="og:description" content="MIT-6.824-Lab2 前言 这个Lab我们主要是为了实现Raft论文中的功能，包括：选举、日志、持久化以及快照。 在开始实现lab之前，需要看一下课程官方提供的la" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ther1sing3un.github.io/mit-6.824-lab2/" /><meta property="og:image" content="https://ther1sing3un.github.io/"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-03-18T11:40:37+08:00" />
<meta property="article:modified_time" content="2022-03-18T11:40:37+08:00" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://ther1sing3un.github.io/"/>

<meta name="twitter:title" content="MIT 6.824 Lab2"/>
<meta name="twitter:description" content="MIT-6.824-Lab2 前言 这个Lab我们主要是为了实现Raft论文中的功能，包括：选举、日志、持久化以及快照。 在开始实现lab之前，需要看一下课程官方提供的la"/>
<meta name="application-name" content="LoveIt">
<meta name="apple-mobile-web-app-title" content="LoveIt"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/images/baseConfig/blogAvatar.svg"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ther1sing3un.github.io/mit-6.824-lab2/" /><link rel="prev" href="https://ther1sing3un.github.io/kv%E5%B1%82%E7%9A%84read%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96/" /><link rel="next" href="https://ther1sing3un.github.io/mit-6.824-lab%E6%8C%87%E5%AF%BC%E7%BF%BB%E8%AF%91/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "MIT 6.824 Lab2",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/ther1sing3un.github.io\/mit-6.824-lab2\/"
        },"image": ["https:\/\/ther1sing3un.github.io\/images\/baseConfig\/blogAvatar.svg"],"genre": "posts","keywords": "分布式系统, Raft, Golang, MIT-6.824","wordcount":  14290 ,
        "url": "https:\/\/ther1sing3un.github.io\/mit-6.824-lab2\/","datePublished": "2022-03-18T11:40:37+08:00","dateModified": "2022-03-18T11:40:37+08:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "TheR1sing3un"
            },"description": ""
    }
    </script></head>
    <body header-desktop="fixed" header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="trs的个人博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/baseConfig/blogAvatar.svg"
        data-srcset="/images/baseConfig/blogAvatar.svg, /images/baseConfig/blogAvatar.svg 1.5x, /images/baseConfig/blogAvatar.svg 2x"
        data-sizes="auto"
        alt="/images/baseConfig/blogAvatar.svg"
        title="/images/baseConfig/blogAvatar.svg" /><span id="id-1" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/about/"> 关于 </a><a class="menu-item" href="/friendship/"> 友链 </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="trs的个人博客"><img
        class="lazyload logo"
        src="/svg/loading.min.svg"
        data-src="/images/baseConfig/blogAvatar.svg"
        data-srcset="/images/baseConfig/blogAvatar.svg, /images/baseConfig/blogAvatar.svg 1.5x, /images/baseConfig/blogAvatar.svg 2x"
        data-sizes="auto"
        alt="/images/baseConfig/blogAvatar.svg"
        title="/images/baseConfig/blogAvatar.svg" /><span id="id-2" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/about/" title="">关于</a><a class="menu-item" href="/friendship/" title="">友链</a><a href="javascript:void(0);" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">目录</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">MIT 6.824 Lab2</h1><h2 class="single-subtitle">基于Raft论文实现一个Raft共识模型</h2><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="/" title="Author" rel=" author" class="author"><i class="fas fa-user-circle fa-fw"></i>TheR1sing3un</a></span>&nbsp;<span class="post-category">收录于 <a href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/"><i class="far fa-folder fa-fw"></i>分布式系统</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2022-03-18">2022-03-18</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 14290 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 29 分钟&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg"
        data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg 2x"
        data-sizes="auto"
        alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg"
        title="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/v2-bb6e4db60499a1d5fd725a9d5e7bac30_1440w.jpg" /></div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言">前言</a>
      <ul>
        <li><a href="#state">State</a></li>
        <li><a href="#appendentries-rpc">AppendEntries RPC</a>
          <ul>
            <li><a href="#接收者实现细节"><strong>接收者实现细节</strong></a>
              <ul>
                <li><a href="#规则3"><strong>规则3</strong></a></li>
                <li><a href="#规则5"><strong>规则5</strong></a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#requestvote-rpc"><strong>RequestVote RPC</strong></a>
          <ul>
            <li><a href="#接收者实现细节-1"><strong>接收者实现细节</strong></a>
              <ul>
                <li><a href="#规则2"><strong>规则2</strong></a></li>
              </ul>
            </li>
          </ul>
        </li>
        <li><a href="#服务器的规则"><strong>服务器的规则</strong></a></li>
      </ul>
    </li>
    <li><a href="#选举"><strong>选举</strong></a>
      <ul>
        <li><a href="#raft服务器参数"><strong>Raft服务器参数</strong></a></li>
        <li><a href="#计时器"><strong>计时器</strong></a></li>
        <li><a href="#实现requestvote"><strong>实现RequestVote</strong></a></li>
        <li><a href="#实现选举"><strong>实现选举</strong></a></li>
        <li><a href="#状态转换"><strong>状态转换</strong></a>
          <ul>
            <li><a href="#成为领袖"><strong>成为领袖</strong></a></li>
            <li><a href="#成为候选人"><strong>成为候选人</strong></a></li>
            <li><a href="#成为跟随者"><strong>成为跟随者</strong></a></li>
          </ul>
        </li>
        <li><a href="#广播"><strong>广播</strong></a></li>
      </ul>
    </li>
    <li><a href="#日志"><strong>日志</strong></a>
      <ul>
        <li><a href="#日志的存储"><strong>日志的存储</strong></a></li>
        <li><a href="#实现appendentries"><strong>实现AppendEntries</strong></a></li>
        <li><a href="#快速恢复"><strong>快速恢复</strong></a></li>
        <li><a href="#发送appendentries"><strong>发送AppendEntries</strong></a></li>
        <li><a href="#更新commitindex"><strong>更新commitIndex</strong></a></li>
        <li><a href="#应用日志到状态机"><strong>应用日志到状态机</strong></a></li>
      </ul>
    </li>
    <li><a href="#持久化"><strong>持久化</strong></a>
      <ul>
        <li><a href="#持久化数据"><strong>持久化数据</strong></a></li>
        <li><a href="#读取持久化数据"><strong>读取持久化数据</strong></a></li>
      </ul>
    </li>
    <li><a href="#快照"><strong>快照</strong></a>
      <ul>
        <li><a href="#论文解析"><strong>论文解析</strong></a></li>
        <li><a href="#实现快照"><strong>实现快照</strong></a></li>
        <li><a href="#实现installsnapshot"><strong>实现InstallSnapshot</strong></a></li>
        <li><a href="#实现snapshot"><strong>实现Snapshot</strong></a></li>
        <li><a href="#实现condinstallsnapshot"><strong>实现CondInstallSnapshot</strong></a></li>
        <li><a href="#实现快照持久化"><strong>实现快照持久化</strong></a></li>
        <li><a href="#实现发送installsnap"><strong>实现发送InstallSnap</strong></a></li>
      </ul>
    </li>
    <li><a href="#总结"><strong>总结</strong></a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h1 id="mit-6824-lab2">MIT-6.824-Lab2</h1>
<h2 id="前言">前言</h2>
<p>这个Lab我们主要是为了实现Raft论文中的功能，包括：选举、日志、持久化以及快照。</p>
<blockquote>
<p>在开始实现lab之前，需要看一下课程官方提供的lab指导</p>
</blockquote>
<p><a href="http://nil.csail.mit.edu/6.824/2021/labs/lab-raft.html" target="_blank" rel="noopener noreffer">lab2官方指导</a></p>
<p><a href="/mit-6.824-lab%e6%8c%87%e5%af%bc%e7%bf%bb%e8%af%91/" rel="">个人翻译后的官方指导</a></p>
<blockquote>
<p>强烈建议把Raft论文多看几遍，并且可以自己做一些总结。</p>
</blockquote>
<p><strong>重点看懂如下内容：</strong></p>
<p><a href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf" target="_blank" rel="noopener noreffer">Raft论文</a>论文中的<strong>Figure2</strong></p>
<h3 id="state">State</h3>
<p><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png" title="image-20220317203458927" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png" data-sub-html="<h2>Raft的状态</h2><p>image-20220317203458927</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317203458927.png" />
    </a><figcaption class="image-caption">Raft的状态</figcaption>
    </figure></p>
<p><strong>所有服务器的持久化状态：</strong></p>
<blockquote>
<p>在响应RPC之前在稳定的存储上进行更新</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>currentTerm</strong></td>
<td><strong>服务器已知的最新任期(在第一次启动时初始化为0，单调递增)</strong></td>
</tr>
<tr>
<td><strong>voteFor</strong></td>
<td><strong>当前任期投给的候选人的Id(如果为null就是没有投票)</strong></td>
</tr>
<tr>
<td><strong>log[]</strong></td>
<td><strong>日志项；每一个日志条目包含一个给状态机的命令，以及当它被leader接收的时候所处的任期(第一个索引是1)</strong></td>
</tr>
</tbody>
</table>
<p><strong>所有服务器的易失状态：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>commitIndex</strong></td>
<td><strong>已知被提交的最高日志的索引(初始化为0，单调递增)</strong></td>
</tr>
<tr>
<td><strong>lastApplied</strong></td>
<td><strong>被状态机应用的最高日志的索引(初始化为0，单调递增)</strong></td>
</tr>
</tbody>
</table>
<p><strong>领袖节点的易失状态：</strong></p>
<blockquote>
<p>选举后重新初始化</p>
</blockquote>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>nextIndex[]</strong></td>
<td><strong>对于每一个服务器，下一个应该被发送给他们的日志的索引(初始化为领袖的最近一个日志的index的下一位)</strong></td>
</tr>
<tr>
<td><strong>matchIndex[]</strong></td>
<td><strong>对于每一个服务器，领袖已知的这些节点分别复制到的最高日志的索引(初始化为0，单调递增)</strong></td>
</tr>
</tbody>
</table>
<hr>
<h3 id="appendentries-rpc">AppendEntries RPC</h3>
<p><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png" title="image-20220317205429607" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png" data-sub-html="<h2>日志复制请求</h2><p>image-20220317205429607</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317205429607.png" />
    </a><figcaption class="image-caption">日志复制请求</figcaption>
    </figure></p>
<blockquote>
<p>由领袖调用去将日志条目复制到节点；也用其作为心跳。</p>
</blockquote>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>领袖的当前任期</strong></td>
</tr>
<tr>
<td><strong>leaderId</strong></td>
<td><strong>领袖的Id，可以用于跟随者记录下来，直接重定向客户端的请求</strong></td>
</tr>
<tr>
<td><strong>prevLogIndex</strong></td>
<td><strong>最新的日志的前一个日志的索引</strong></td>
</tr>
<tr>
<td><strong>prevLogTerm</strong></td>
<td><strong>preLogIndex处的日志的所属任期</strong></td>
</tr>
<tr>
<td><strong>entries[]</strong></td>
<td><strong>发送给跟随者去存储的日志条目(空的表示当前的RPC为心跳包；可以发送不知一个用于提效率)</strong></td>
</tr>
<tr>
<td><strong>ledaerCommit</strong></td>
<td><strong>领袖的commitIndex(用于跟随者更新自己的commitIndex)</strong></td>
</tr>
</tbody>
</table>
<p><strong>结果：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>服务器当前的任期，用于领袖更新自己的任期</strong></td>
</tr>
<tr>
<td><strong>success</strong></td>
<td><strong>如果跟随着包含匹配preLogIndex和preLogTerm的日志就返回true</strong></td>
</tr>
</tbody>
</table>
<p><strong>接收者实现：</strong></p>
<ol>
<li><strong>当<code>term</code> &lt; <code>currentTerm</code>，返回false。(即发送<code>AppendEntries</code>的服务器肯定不是现在的领袖，那么返回false表示不接收这个日志复制请求)</strong></li>
<li><strong>如果接收者在<code>prevLogIndex</code>处的日志的任期没有和<code>prevLogTerm</code>匹配，那么返回false。(表示当前追加的日志条目开始的位置不对)</strong></li>
<li><strong>如果服务器存在一个日志和新的需要复制的日志冲突了(相同的索引但是属于不同的任期)，那么删除掉这个日志条目以及所有处于它后面的日志。</strong></li>
<li><strong>追加所有当前服务器没有的新日志。</strong></li>
<li><strong>如果领袖的<code>leaderCommit</code> &gt; 当前服务器的<code>commitIndex</code>，设置<code>commitIndex</code> = <code>min(leaderCommit, index of last new Entry)</code>。</strong></li>
</ol>
<h4 id="接收者实现细节"><strong>接收者实现细节</strong></h4>
<h5 id="规则3"><strong>规则3</strong></h5>
<p><strong>有如下情况：</strong></p>
<p><strong>当A节点当选领袖后，它的任期为3，并且接收到了两条新的日志，它将其发送给别的跟随着B,C,D,E。	但是刚发送给B，B成功复制，但是还没有发送给CDE或者发送给CDE的消息因为网络原因丢失了。那么就出现了如下情况。</strong></p>
<blockquote>
<p><strong>日志情况如下</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>服务器名称</strong></th>
<th><strong>日志的索引和任期(index/term)</strong></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/3</strong></td>
<td><strong>5/3</strong></td>
</tr>
<tr>
<td><strong>B</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/3</strong></td>
<td><strong>5/3</strong></td>
</tr>
<tr>
<td><strong>C</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>D</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td></td>
<td></td>
</tr>
<tr>
<td><strong>E</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>此时日志4和5由于领袖没有成功复制到大多数节点，因此并没有被提交</strong></p>
<p><strong>这时候C/D/E可以通过选举得到除了A/B以外的节点同意，因此可以成为新的领袖，这时候由于日志4/3和5/3没有成功被提交，因此领袖可以对其进行删除后再追加新的日志，这也就是规则3需要应对的情况。</strong></p>
<blockquote>
<p><strong>此时日志情况如下</strong></p>
</blockquote>
<table>
<thead>
<tr>
<th><strong>服务器名称</strong></th>
<th><strong>日志的索引和任期(index/term)</strong></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>A</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/4</strong></td>
<td><strong>5/4</strong></td>
</tr>
<tr>
<td><strong>B</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/4</strong></td>
<td><strong>5/4</strong></td>
</tr>
<tr>
<td><strong>C</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/4</strong></td>
<td><strong>5/4</strong></td>
</tr>
<tr>
<td><strong>D</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/4</strong></td>
<td><strong>5/4</strong></td>
</tr>
<tr>
<td><strong>E</strong></td>
<td><strong>1/1</strong></td>
<td><strong>2/1</strong></td>
<td><strong>3/2</strong></td>
<td><strong>4/4</strong></td>
<td><strong>5/4</strong></td>
</tr>
</tbody>
</table>
<hr>
<h5 id="规则5"><strong>规则5</strong></h5>
<p><strong>跟随者成功接收了领袖的<code>AppendEntire RPC</code>时，设置跟随者自己的<code>commitIndex</code> = <code>min(leaderCommit, index of last new entry)</code>。因为有可能领袖的发送给该跟随者的日志最大索引也比当前领袖的<code>commitIndex</code>要小，所以要在<code>leaderCommit</code>和自己当前最新接收的日志中找那个更小的作为更新的数据。可以防止更新了<code>commitIndex</code>但是现在跟随者的日志并没有更新到该索引，导致错误。</strong></p>
<hr>
<h3 id="requestvote-rpc"><strong>RequestVote RPC</strong></h3>
<p><strong><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png" title="image-20220317210920159" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png" data-sub-html="<h2>请求投票RPC方法</h2><p>image-20220317210920159</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220317210920159.png" />
    </a><figcaption class="image-caption">请求投票RPC方法</figcaption>
    </figure></strong></p>
<blockquote>
<p><strong>由候选人调用来收集选票</strong></p>
</blockquote>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>候选人的任期</strong></td>
</tr>
<tr>
<td><strong>candidateId</strong></td>
<td><strong>请求投票的候选人Id</strong></td>
</tr>
<tr>
<td><strong>lastLogIndex</strong></td>
<td><strong>候选人的最近一个日志条目的索引</strong></td>
</tr>
<tr>
<td><strong>lastLogTerm</strong></td>
<td><strong>候选人的最近一个日志条目的所属任期</strong></td>
</tr>
</tbody>
</table>
<p><strong>结果：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>服务器当前的任期，用于候选人更新自己</strong></td>
</tr>
<tr>
<td><strong>voteGranted</strong></td>
<td><strong>当候选人符合条件的时候，返回true表示成功投票给它</strong></td>
</tr>
</tbody>
</table>
<p><strong>接收者实现：</strong></p>
<ol>
<li><strong>如果<code>term</code> &lt; <code>currentTerm</code>返回false。(即候选人的任期比当前服务器的任期还小，自然不可能成为领袖，因此返回false)</strong></li>
<li><strong>当该服务器的<code>voteFor</code>是空或者就是当前请求投票的这个候选人，以及候选人的日志最少和接受者的日志一样新，那么就给它投票。</strong></li>
</ol>
<h4 id="接收者实现细节-1"><strong>接收者实现细节</strong></h4>
<h5 id="规则2"><strong>规则2</strong></h5>
<p><strong>当服务器的<code>voteFor</code>为空或者就是当前请求投票的这个候选人的id，而且需要候选人的日志最少和它一样新，才会给它投票。</strong></p>
<p><strong>首先，为了防止出现脑裂的情况，我们一个任期只能有一个领袖，因此如果当前任期已经投票了，就不要再投了，除非是当前已经投给的那个候选人又发了一次<code>RequestVote RPC</code>。而且只有当候选人的日志最少和该服务器的日志一样新的时候，才能投票。</strong></p>
<p><strong>这里的最少一样新，可以理解为，最新日志的任期更大，或者相同任期但是索引更大。</strong></p>
<hr>
<h3 id="服务器的规则"><strong>服务器的规则</strong></h3>
<p><strong><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png" title="image-20220318215512320" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png" data-sub-html="<h2>服务器需要遵守的规则</h2><p>image-20220318215512320</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220318215512320.png" />
    </a><figcaption class="image-caption">服务器需要遵守的规则</figcaption>
    </figure></strong></p>
<p><strong>对于所有服务器</strong></p>
<ul>
<li><strong>如果<code>commitIndex</code> &gt; <code>lastApplied</code>：自增<code>lastApplied</code>，并且将索引为<code>lastApplied</code>的日志应用到状态机中。</strong></li>
<li><strong>如果RPC请求或者响应中的参数<code>term</code> &gt; <code>currentTerm</code>：那么更新<code>currentTerm</code>和<code>term</code>相等，然后转化为跟随者。(也就是当前自己任期比别人的小的时候，自己当前一定只能为跟随者，并且需要更新到相同的任期)</strong></li>
</ul>
<p><strong>对于跟随者</strong></p>
<ul>
<li><strong>响应候选人和领袖发来的RPC。</strong></li>
<li><strong>如果选举计时器到期了还没有收到正确的领袖发来的<code>AppendEntries</code>，或者没有投票给候选人，那么就变成了候选人。</strong></li>
</ul>
<p><strong>对于候选人</strong></p>
<ul>
<li><strong>转换为候选人的时候，开始选举。</strong>
<ul>
<li><strong>自增当前的任期号<code>currentTerm</code></strong></li>
<li><strong>给自己投票(防止又给别人投票，出现脑裂)</strong></li>
<li><strong>重置选举计时器</strong></li>
<li><strong>给所有其他的服务器发送<code>RequestVote RPC</code></strong></li>
</ul>
</li>
<li><strong>如果从大多数服务器收到了选票，那么成为当前任期的领袖。</strong></li>
<li><strong>从一个新的领袖那里接收到<code>AppendEntries RPC</code>，就转换为跟随者。</strong></li>
<li><strong>如果选举计时器到期，开始一轮选举。</strong></li>
</ul>
<p><strong>对于领袖</strong></p>
<ul>
<li><strong>选举后：发送初始化的<code>AppendEntries RPC</code>空包(心跳包)到每一个服务器；并在空闲时期不断发送来防止跟随者选举计时器到期。(为了维护自己的领袖地位)</strong></li>
<li><strong>如果从客户端接收到一个命令：追加日志到本机日志，然后当状态机成功应用该日志之后再响应客户端的请求。</strong></li>
<li><strong>如果最新的日志的索引&gt;=该跟随者的<code>nextIndex</code>：发送携带从<code>nextIndex</code>开始的日志条目的<code>AppendEntries RPC</code>请求到跟随者。</strong>
<ul>
<li><strong>如果成功了：更新该跟随者的<code>nextIndex</code>和<code>matchIndex</code>。(这里一定要注意并发问题，后续会提到)</strong></li>
<li><strong>如果是因为日志不一致而导致的失败：递减<code>nextIndex</code>然后重试。(我们采取优化的Fast Backup，可以快速的进行日志的同步)</strong></li>
</ul>
</li>
<li><strong>如果存在一个大于<code>commitIndex</code>的N，大多数跟随者的<code>matchIndex[i] &gt; N</code>，而且索引为N的日志的任期等于当前任期，那么设置<code>commitIndex = N</code>。</strong></li>
</ul>
<hr>
<hr>
<h2 id="选举"><strong>选举</strong></h2>
<h3 id="raft服务器参数"><strong>Raft服务器参数</strong></h3>
<p><strong>我们需要如下参数：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Raft</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">mu</span>        <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>          <span class="c1">// Lock to protect shared access to this peer&#39;s state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">peers</span>     <span class="p">[]</span><span class="o">*</span><span class="nx">labrpc</span><span class="p">.</span><span class="nx">ClientEnd</span> <span class="c1">// RPC end points of all peers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">persister</span> <span class="o">*</span><span class="nx">Persister</span>          <span class="c1">// Object to hold this peer&#39;s persisted state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">me</span>        <span class="kt">int</span>                 <span class="c1">// this peer&#39;s index into peers[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">dead</span>      <span class="kt">int32</span>               <span class="c1">// set by Kill()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your data here (2A, 2B, 2C).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Look at the paper&#39;s Figure 2 for a description of what
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// state a Raft server must maintain.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="c1">//persistent state
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">currentTerm</span> <span class="kt">int</span>        <span class="c1">//当前任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">voteFor</span>     <span class="kt">int</span>        <span class="c1">//当前任期投给的候选人id(为-1时代表没有投票)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">logEntries</span>  <span class="p">[]</span><span class="nx">LogEntry</span> <span class="c1">//日志条目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">commitIndex</span> <span class="kt">int</span>        <span class="c1">//当前log中的最高索引(从0开始,递增)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">lastApplied</span> <span class="kt">int</span>        <span class="c1">//当前被用到状态机中的日志最高索引(从0开始,递增)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//volatile state on leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">nextIndex</span>  <span class="p">[]</span><span class="kt">int</span> <span class="c1">//发送给每台服务器的下一条日志目录索引(初始值为leader的commitIndex + 1)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">matchIndex</span> <span class="p">[]</span><span class="kt">int</span> <span class="c1">//每台服务器已知的已被复制的最高日志条目索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//volatile state on all servers
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">state</span> <span class="nx">State</span> <span class="c1">//当前raft状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">   <span class="nx">timerElect</span>       <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Timer</span>   <span class="c1">//选举计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">timerHeartBeat</span>   <span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Timer</span>   <span class="c1">//心跳计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">timeoutHeartBeat</span> <span class="kt">int</span>           <span class="c1">//心跳频率/ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">timeoutElect</span>     <span class="kt">int</span>           <span class="c1">//选举频率/ms
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">applyCh</span>          <span class="kd">chan</span> <span class="nx">ApplyMsg</span> <span class="c1">//命令应用通道
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">applyCond</span>        <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">Cond</span>    <span class="c1">//命令应用cond
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//最近快照的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">snapshotData</span> <span class="p">[]</span><span class="kt">byte</span> <span class="c1">//最近快照的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// LogEntry 日志条目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">LogEntry</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Command</span> <span class="kd">interface</span><span class="p">{}</span> <span class="c1">//日志记录的命令(用于应用服务的命令)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Index</span>   <span class="kt">int</span>         <span class="c1">//该日志的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Term</span>    <span class="kt">int</span>         <span class="c1">//该日志被接收的时候的Leader任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="计时器"><strong>计时器</strong></h3>
<p><strong>首先，我们是需要周期性的进行选举的，因此肯定是需要实现一个选举计时器的，那么我们可以直接实现如下代码，使用<code>time.Timer</code>来作为定时器。</strong></p>
<blockquote>
<p><strong>实现<code>ticker</code>方法，该方法不断进行超时判断</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">ticker</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="o">==</span> <span class="kc">false</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1">// Your code here to check if a leader election should
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// be started and to randomize sleeping time using
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// time.Sleep().
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">select</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">timerElect</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 选举计时器到期\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">LEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//当不为leader时,也就是超时了,那么转变为Candidate
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">rf</span><span class="p">.</span><span class="nf">startElection</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//重置选举计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">rf</span><span class="p">.</span><span class="nf">resetElectTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">timerHeartBeat</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">LEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//当心跳计时器到时间后,如果是Leader就开启心跳检测
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">Broadcast</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//重置心跳计时器
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">timerHeartBeat</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">timeoutHeartBeat</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="实现requestvote"><strong>实现RequestVote</strong></h3>
<p><strong>现在需要完成的就是<code>RequestVote RPC</code>。结合上述规则，可得代码如下(相信我的注释应该很详细的~)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// RequestVote
</span></span></span><span class="line"><span class="cl"><span class="c1">// example RequestVote RPC handler.
</span></span></span><span class="line"><span class="cl"><span class="c1">//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">RequestVote</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">RequestVoteArgs</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">RequestVoteReply</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your code here (2A, 2B).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//无论如何,返回参数中的term应修改为自己的term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 接收到[%d]的选举申请\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 给[%d]的选举申请返回%v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">VoteGranted</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">reply</span><span class="p">.</span><span class="nx">VoteGranted</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//1.如果Term&lt;currentTerm或者已经投过票了,则之直接返回拒绝
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="o">||</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="o">!=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">CandidateId</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//2.如果t &gt; currentTerm,则更新currentTerm,并切换为follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//3.判断候选人的日志是否最少一样新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//如果两份日志最后的条目的任期号不同,那么任期号大的日志更加新;如果两份日志最后的条目任期号相同,那么日志比较长的那个就更加新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Term</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastLogTerm</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Term</span> <span class="o">||</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">LastLogTerm</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Term</span> <span class="o">&amp;&amp;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastLogIndex</span> <span class="o">&gt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//重置选举时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nf">resetElectTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//投票给候选人
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">CandidateId</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//投赞成
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reply</span><span class="p">.</span><span class="nx">VoteGranted</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AppendEntriesArgs 日志追加RPC的请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AppendEntriesArgs</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Term</span>         <span class="kt">int</span>        <span class="c1">//当前leader的任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">LeaderId</span>     <span class="kt">int</span>        <span class="c1">//leader的id,follower可以将client错发给它的请求转发给leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">PrevLogIndex</span> <span class="kt">int</span>        <span class="c1">//最新日志前的那一条日志条目的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">PrevLogTerm</span>  <span class="kt">int</span>        <span class="c1">//最新日志前的那一条日志条目的任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Entries</span>      <span class="p">[]</span><span class="nx">LogEntry</span> <span class="c1">//需要被保存的日志条目(为空则为心跳包)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">LeaderCommit</span> <span class="kt">int</span>        <span class="c1">//leader的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AppendEntriesReply 日志追加的RPC的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AppendEntriesReply</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Term</span>    <span class="kt">int</span>  <span class="c1">//接收者的currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Success</span> <span class="kt">bool</span> <span class="c1">//如果prevLogIndex和prevLogTerm和follower的匹配则返回true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">XTerm</span>   <span class="kt">int</span>  <span class="c1">//若follower和leader的日志冲突,则记载的是follower的log在preLogIndex处的term,若preLogIndex处无日志,返回-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">XIndex</span>  <span class="kt">int</span>  <span class="c1">//follower中的log里term为XTerm的第一条log的index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">XLen</span>    <span class="kt">int</span>  <span class="c1">//当XTerm为-1时,此时XLen记录follower的日志长度(不包含初始占位日志)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="实现选举"><strong>实现选举</strong></h3>
<p><strong>上述的<code>ticker</code>方法，我们会调用一个<code>rf.startElection()</code>方法来进行选举，代码实现如下。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// StartElection 发起选举
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">startElection</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nf">toCandidate</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">voteNums</span> <span class="o">:=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">args</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">RequestVoteArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">Term</span><span class="p">:</span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">CandidateId</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">LastLogIndex</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">LastLogTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">i</span> <span class="kt">int</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">reply</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">RequestVoteReply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">         <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">sendRequestVote</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="o">==</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">CANDIDATE</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">VoteGranted</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="nx">voteNums</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="nx">voteNums</span> <span class="p">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                     <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">toLeader</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">               <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">               <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">               <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当获得大多数选票的时候，就成为了当前任期的领袖。</strong></p>
<hr>
<h3 id="状态转换"><strong>状态转换</strong></h3>
<h4 id="成为领袖"><strong>成为领袖</strong></h4>
<p><strong>上述选举后，若成功的当选领袖，那么就需要转化为领袖的操作，代码实现如下，全部基于解析的论文中的<code>Figure2</code>中的规则：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// toLeader 转变为leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">toLeader</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 成为Leader\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">LEADER</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//1.初始化volatile state on leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//初始化nextIndex为commitIndex+1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//初始化matchIndex为0(实例化的时候已经赋值0了,不需要自己再赋值一次了)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//当为leader时,开始启动协程来实时更新commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">updateCommitIndex</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//追加一条空日志,用于更新到最新的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//立马开始一轮心跳
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">timerHeartBeat</span><span class="p">.</span><span class="nf">Reset</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>当成为领袖之后，需要启动一个协程来更新自己的<code>commitIndex</code>(上述解析中提到，领袖的<code>commitIndex</code>需要再合适的时候进行更新)。</strong></p>
<p><strong>还需要立马开始一轮心跳，也就是发送一轮<code>AppendEntries RPC</code>。</strong></p>
<p><strong>这里的代码中还有一个立马进行保存一个空日志的逻辑，这个后续会讲到，属于是优化的内容。</strong></p>
<h4 id="成为候选人"><strong>成为候选人</strong></h4>
<p><strong>当我们选举计时器到期后，需要转化为候选人并进行选举。根据论文中规则，需要自增自己的任期，并且给自己投票。代码实现如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//转变为候选人
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">toCandidate</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//切换状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">CANDIDATE</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//自增任期号
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//给自己投票
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 变成Candidate\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="成为跟随者"><strong>成为跟随者</strong></h4>
<p><strong>当服务器接收到比自己任期大的服务器发来的请求或者响应的时候，或者投出选票的时候，需要转化为跟随者。</strong></p>
<p><strong>代码实现如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//转变为follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">toFollower</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">FOLLOWER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">FOLLOWER</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 变成Follower\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="广播"><strong>广播</strong></h3>
<p><strong>当服务器成为领袖之后，为了维护自己的领袖地位，需要周期性的发送<code>AppendEntries RPC</code>到跟随者，为了重置他们的选举计时器，也是为了进行日志复制。代码实现如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// Broadcast 发起广播发送AppendEntries RPC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">Broadcast</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">LEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 开始一轮广播\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">i</span> <span class="o">!=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">HandleAppendEntries</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>这里的<code>rf.HandleAppendEntries()</code>方法在选举模块只需要实现发送空的<code>AppendEntries RPC</code>即可，发送日志在后续实现</strong></p>
<hr>
<hr>
<h2 id="日志"><strong>日志</strong></h2>
<p><strong>这一模块需要实现Raft之间的日志复制，重点是实现<code>AppendEntries RPC</code>以及发送<code>AppendEntries RPC</code>的方法<code>HandleAppendEntries</code>。</strong></p>
<h3 id="日志的存储"><strong>日志的存储</strong></h3>
<p><strong>我们将日志存在Raft的变量<code>logEntries</code>中，是由<code>LonEntry</code>数组构成，并且<code>LogEntry</code>中存有命令、索引和任期。</strong></p>
<p><strong><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319112044841.png"
        data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319112044841.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319112044841.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319112044841.png 2x"
        data-sizes="auto"
        alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319112044841.png"
        title="image-20220319112044841" /></strong></p>
<blockquote>
<p><strong><code>LogEntry</code>数据结构</strong></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// LogEntry 日志条目
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">LogEntry</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Command</span> <span class="kd">interface</span><span class="p">{}</span> <span class="c1">//日志记录的命令(用于应用服务的命令)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Index</span>   <span class="kt">int</span>         <span class="c1">//该日志的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Term</span>    <span class="kt">int</span>         <span class="c1">//该日志被接收的时候的Leader任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>我们将索引存在该数据结构里面而不是以数组的下标为索引，原因是：</strong></p>
<ul>
<li><strong>更容易操作，数组反而涉及到很多下标变化之类的问题。</strong></li>
<li><strong>后续我们的日志会进行快照，也就是该数组中第一个日志并不是索引为1了。</strong></li>
</ul>
<hr>
<h3 id="实现appendentries"><strong>实现AppendEntries</strong></h3>
<p><strong>根据上述分析的论文中的规则，可以实现代码如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span><span class="lnt">92
</span><span class="lnt">93
</span><span class="lnt">94
</span><span class="lnt">95
</span><span class="lnt">96
</span><span class="lnt">97
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// AppendEntriesArgs 日志追加RPC的请求参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AppendEntriesArgs</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Term</span>         <span class="kt">int</span>        <span class="c1">//当前leader的任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">LeaderId</span>     <span class="kt">int</span>        <span class="c1">//leader的id,follower可以将client错发给它的请求转发给leader
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PrevLogIndex</span> <span class="kt">int</span>        <span class="c1">//最新日志前的那一条日志条目的索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">PrevLogTerm</span>  <span class="kt">int</span>        <span class="c1">//最新日志前的那一条日志条目的任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Entries</span>      <span class="p">[]</span><span class="nx">LogEntry</span> <span class="c1">//需要被保存的日志条目(为空则为心跳包)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">LeaderCommit</span> <span class="kt">int</span>        <span class="c1">//leader的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AppendEntriesReply 日志追加的RPC的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">AppendEntriesReply</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nx">Term</span>    <span class="kt">int</span>  <span class="c1">//接收者的currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">Success</span> <span class="kt">bool</span> <span class="c1">//如果prevLogIndex和prevLogTerm和follower的匹配则返回true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">XTerm</span>   <span class="kt">int</span>  <span class="c1">//若follower和leader的日志冲突,则记载的是follower的log在preLogIndex处的term,若preLogIndex处无日志,返回-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">XIndex</span>  <span class="kt">int</span>  <span class="c1">//follower中的log里term为XTerm的第一条log的index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>	<span class="nx">XLen</span>    <span class="kt">int</span>  <span class="c1">//当XTerm为-1时,此时XLen记录follower的日志长度(不包含初始占位日志)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// AppendEntries 日志追加的RPC handler
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">AppendEntries</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">AppendEntriesArgs</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">AppendEntriesReply</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//将自己的term返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 接收到[%d],term[%d]的日志追加,preLogIndex = [%d], preLogTerm = [%d],entries = [%v]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LeaderId</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//DPrintf(&#34;id[%d].state[%v].term[%d]: 此时已有的log=[%v]\n&#34;, rf.me, rf.state, rf.currentTerm, rf.logEntries)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//判断term是否小于当前任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加日志的任期%d小于当前任期%d\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//若请求的term大于该server的term,则更新term并且将voteFor置为未投票
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//重置选举时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">resetElectTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//转变为follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//进行日志一致性判断(快速恢复)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//若leader在preLogIndex处没有日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span> <span class="p">&lt;</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//preLogIndex处无日志,记录XTerm为-1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//记录XLen为当前最新日志的index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reply</span><span class="p">.</span><span class="nx">XLen</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加日志的和现在的日志不匹配\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">XLen</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//若preLogIndex处的日志的term和preLogTerm不相等(或者)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="o">&lt;=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">).</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//更新XTerm为冲突的Term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">).</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//更新XIndex为XTerm在本机log中第一个Index位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">reply</span><span class="p">.</span><span class="nx">XIndex</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindFirstIndexByTerm</span><span class="p">(</span><span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加日志的和现在的日志不匹配\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//追加
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">logEntry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">index</span> <span class="o">:=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="o">+</span> <span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">index</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">,</span> <span class="nx">logEntry</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">index</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//当追加的日志处于快照部分,那么直接跳过不处理该日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">continue</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nx">index</span><span class="p">).</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">logEntry</span><span class="p">.</span><span class="nx">Term</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[:</span><span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)]</span> <span class="c1">// 删除当前以及后续所有log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">,</span> <span class="nx">logEntry</span><span class="p">)</span>                             <span class="c1">// 把新log加入进来
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">// term一样啥也不用做，继续向后比对Log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加后的的log=[%v]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//更新follower的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">updateCommitIndexForFollower</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">LeaderCommit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>但是这里大家会发现返回值的参数有一些不同，是因为我们使用了快速恢复进行优化</strong></p>
<hr>
<h3 id="快速恢复"><strong>快速恢复</strong></h3>
<p><strong>上述提到的快速恢复，也就是Fast Backup，是用来快速的使跟随者复制到和领袖一样的日志。论文中提到的如果<code>AppendEntries RPC</code>因为日志不一致而导致失败，那么就需要将<code>nextIndex</code>自减，然后再次发送请求。</strong></p>
<p><strong><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png" title="image-20220319124309763" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png" data-sub-html="<h2>论文中的发送失败后的规则</h2><p>image-20220319124309763</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319124309763.png" />
    </a><figcaption class="image-caption">论文中的发送失败后的规则</figcaption>
    </figure></strong></p>
<p><strong>那么如果出现一个情况，领袖这时候的最新日志的索引已经达到了100万，然后有一个服务器因为网络原因，一直没有被正确的接收到领袖的<code>AppendEnrties RPC</code>，导致现在该跟随者最新的日志索引为1。这时候网络恢复正常了，就需要同步几万条，但是这时候如果领袖是新当选的，它会初始化<code>nextIndex</code>为最新的日志索引+1，也就是100万零1，那么如果我们每次自减一次，就需要进行100万次<code>AppendEntries RPC</code>才能正确的发送日志。会严重影响到效率。</strong></p>
<p><strong>因此可以采用快速恢复的方法。</strong></p>
<p><strong>快速恢复原理</strong></p>
<p><strong>可以在<code>AppendEntries RPC</code>的回复参数中加上三个参数：</strong></p>
<ul>
<li><strong>XTerm：这个是跟随者中与领袖冲突的日志对应的任期。如果跟随者在请求的参数中的<code>prevLogIndex</code>处的日志任期号和参数中的<code>prevLogTerm</code>不匹配，它会拒绝领袖的<code>AppendEntries</code>消息，并将自己的任期号放在XTerm中。如果跟随者在对应位置没有日志，那么这里会返回 -1。</strong></li>
<li><strong>XIndex：这个是跟随者中，对应任期号为XTerm的第一条日志条目的槽位号。(也就代表着从该处开始冲突，也就需要从该处开始复制日志)</strong></li>
<li><strong>XLen：如果跟随者在<code>prevLogIndex</code>处没有日志，那么XTerm会返回-1，XLen表示最新的日志。</strong></li>
</ul>
<p><strong>那么这时候只需要一次<code>AppendEntries RPC</code>就可以让领袖知道我需要给跟随者发送从哪里开始的日志，也就达到了快速将跟随者的日志和领袖保持一致了。</strong></p>
<hr>
<h3 id="发送appendentries"><strong>发送AppendEntries</strong></h3>
<p><strong>也就是实现上面提到的<code>HandleAppendEntries</code>方法，由于我已经全部完成了，所以下面代码中还包括了快照模块的代码，自行忽略即可。</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// HandleAppendEntries handle对AppendEntries的发送和返回处理(这里返回值表示这次请求目标follower是否仍认为自己是leader)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">HandleAppendEntries</span><span class="p">(</span><span class="nx">server</span> <span class="kt">int</span><span class="p">)</span> <span class="p">(</span><span class="nx">success</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">success</span> <span class="p">=</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">LEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//DPrintf(&#34;id[%d].state[%v].term[%d]: leader此时的log=[%v]\n&#34;, rf.me, rf.state, rf.currentTerm, rf.logEntries)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: server[%d]的nextIndex=[%d],matchIndex=[%d],lastIncludedIndex=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//检查此时是否传的日志存在于快照中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">args</span> <span class="o">:=</span> <span class="nx">InstallSnapshotArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">Term</span><span class="p">:</span>              <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">LeaderId</span><span class="p">:</span>          <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">LastIncludedIndex</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">LastIncludedTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="nx">Data</span><span class="p">:</span>              <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshotData</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span> <span class="o">:=</span> <span class="nx">InstallSnapshotReply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送installSnapshot to [%d];lastIncludedIndex=[%d],lastIncludedTerm=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">sendInstallSnapshot</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//过期的请求直接结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">LEADER</span> <span class="o">||</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送installSnapshot to [%d] error\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送installSnapshot to [%d] 过期,转变为follower\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">success</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//若安装成功,则更新nextIndex和matchIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送installSnapshot to [%d] 成功,更新nextIndex-&gt;[%d];matchIndex-&gt;[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//若不存在于快照中,则正常appendEntries
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">args</span> <span class="o">:=</span> <span class="nx">AppendEntriesArgs</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Term</span><span class="p">:</span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">LeaderId</span><span class="p">:</span>     <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">PrevLogIndex</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">PrevLogTerm</span><span class="p">:</span>  <span class="nx">rf</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">).</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">LeaderCommit</span><span class="p">:</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//添加需要发送的日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">LogEntry</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">)</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">   <span class="nb">copy</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]):])</span>
</span></span><span class="line"><span class="cl">   <span class="nx">reply</span> <span class="o">:=</span> <span class="nx">AppendEntriesReply</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送appendEntries to [%d];PrevLogIndex=[%d];Entries=[%v]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">sendAppendEntries</span><span class="p">(</span><span class="nx">server</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">reply</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//过期的请求直接结束
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">LEADER</span> <span class="o">||</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="o">!=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送ae to [%d] error\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//判断是否任期更大,更新自身状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//修改term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//转变为follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//更新为未投票
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 发送ae to [%d] 过期,转变为follower\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: follower仍认为自己是leader\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">success</span> <span class="p">=</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//若返回失败
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="p">!</span><span class="nx">reply</span><span class="p">.</span><span class="nx">Success</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//更新nextIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//当follower的preLogIndex处无日志时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">XTerm</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//更新nextIndex为follower的最后一条日志的下一个位置
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">XLen</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//当preLogIndex处的日志任期冲突时
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">//更新nextIndex为该冲突任期的第一条日志的位置,为了直接覆盖冲突的任期的所有的日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">XIndex</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加日志到server[%d]失败,更新nextIndex-&gt;[%d],matchIndex-&gt;[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//若成功
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">PrevLogIndex</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//只有发送了不为空的日志(也就不是心跳包的时候)才真正的更新了,心跳包相当于没更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">Entries</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 追加日志到server[%d]成功,更新nextIndex-&gt;[%d],matchIndex-&gt;[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">server</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">server</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="更新commitindex"><strong>更新commitIndex</strong></h3>
<p><strong>根据论文中提到的规则，我们需要不断更新领袖的<code>commitIndex</code>，那么我们就可以写一个方法，周期性的检查从最新的日志一直到当前的<code>commitIndex+1</code>处的日志，是否有超过一半的<code>matchIndex</code>达到了其中的日志索引处，若有则更新<code>commitIndex</code>为那个索引。之所以从最新的开始往前检查，是因为这样可以快速定位到目标索引。</strong></p>
<p><strong>代码实现如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// updateCommitIndex 检查更新commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">updateCommitIndex</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">!</span><span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">LEADER</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//从lastLog开始
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">updateConNum</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">         <span class="nx">num</span> <span class="o">:=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">         <span class="k">for</span> <span class="nx">j</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="nx">j</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="k">continue</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//若match[j] &gt;= i 而且log[i].Term == currentTerm则该server符合更新要求
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span><span class="p">[</span><span class="nx">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="nx">i</span> <span class="o">&amp;&amp;</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">index</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">Term</span> <span class="o">==</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">               <span class="nx">num</span><span class="o">++</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">         <span class="c1">//若过半数则更新commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="k">if</span> <span class="nx">num</span> <span class="o">&gt;=</span> <span class="nx">updateConNum</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">i</span>
</span></span><span class="line"><span class="cl">            <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: n = %d, 过半节点的matchIndex &gt;= n而且log[n].Term == currentTerm,则更新commitIndex = %d\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="c1">//唤醒ApplyCommand routine
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCond</span><span class="p">.</span><span class="nf">Broadcast</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="k">break</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="应用日志到状态机"><strong>应用日志到状态机</strong></h3>
<p><strong>我们在检查到有可以提交的日志的时候，即可以将其传递给状态机应用，那么就可以开启一个协程用来检查并更新<code>lastApplied</code>以及将其应用到状态机中。而且当当前没有可以应用的日志的时候，就在cond上等待，所有更新<code>commitIndex</code>的代码后面都会唤醒在该<code>cond</code>上等待的协程，也就是<code>ApplyCommand</code>协程。</strong></p>
<p><strong>代码实现如下：</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// ApplyCommand 检查是否 commitIndex &gt; lastApplied,若是则lastApplied递增,并将log[lastApplied]应用到状态机
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">ApplyCommand</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">for</span> <span class="p">!</span><span class="nx">rf</span><span class="p">.</span><span class="nf">killed</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//不符合条件时放弃锁进行等待
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="o">&gt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCond</span><span class="p">.</span><span class="nf">Wait</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//被唤醒而且符合条件
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//当前的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">commitIndex</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span>
</span></span><span class="line"><span class="cl">      <span class="nx">lastApplied</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: apply command [%d,%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastApplied</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="kd">var</span> <span class="nx">applyEntries</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">LogEntry</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="o">-</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nb">copy</span><span class="p">(</span><span class="nx">applyEntries</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">lastApplied</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">commitIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">)])</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//解锁后进行apply
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">entry</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">applyEntries</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCh</span> <span class="o">&lt;-</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nx">CommandValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">Command</span><span class="p">:</span>      <span class="nx">entry</span><span class="p">.</span><span class="nx">Command</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">CommandIndex</span><span class="p">:</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">Index</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nx">CommandTerm</span><span class="p">:</span>  <span class="nx">entry</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">         <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//更新lastApplied,由于在apply过程中进行了解锁,因此不能使用现在的commitIndex,而是之前情况的commitIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//(若在解锁过程中,进行了新的log的apply导致lastApplied更新至比该次更新目标的commitIndex还大,那么保持不变,因此这里的更新需要一个Max()来辅助)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nf">Max</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span><span class="p">,</span> <span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>由于该写成是每一个服务器都需要的，和服务器状态无关，那么就需要在初始化Raft的时候开启(<code>ticker</code>也同理)</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="nf">Make</span><span class="p">(</span><span class="nx">peers</span> <span class="p">[]</span><span class="o">*</span><span class="nx">labrpc</span><span class="p">.</span><span class="nx">ClientEnd</span><span class="p">,</span> <span class="nx">me</span> <span class="kt">int</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="nx">persister</span> <span class="o">*</span><span class="nx">Persister</span><span class="p">,</span> <span class="nx">applyCh</span> <span class="kd">chan</span> <span class="nx">ApplyMsg</span><span class="p">)</span> <span class="o">*</span><span class="nx">Raft</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Raft</span><span class="p">{}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">peers</span> <span class="p">=</span> <span class="nx">peers</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">persister</span> <span class="p">=</span> <span class="nx">persister</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span> <span class="p">=</span> <span class="nx">me</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your initialization code here (2A, 2B, 2C).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">LogEntry</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">,</span> <span class="nx">LogEntry</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">FOLLOWER</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">nextIndex</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">peers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">matchIndex</span> <span class="p">=</span> <span class="nb">make</span><span class="p">([]</span><span class="kt">int</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">peers</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">timeoutHeartBeat</span> <span class="p">=</span> <span class="mi">150</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">timeoutElect</span> <span class="p">=</span> <span class="mi">300</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">timerHeartBeat</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">timeoutHeartBeat</span><span class="p">)</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">timerElect</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTimer</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">timeoutElect</span><span class="o">+</span><span class="nx">rand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCh</span> <span class="p">=</span> <span class="nx">applyCh</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCond</span> <span class="p">=</span> <span class="nx">sync</span><span class="p">.</span><span class="nf">NewCond</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: finish init\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// initialize from state persisted before a crash
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">readPersist</span><span class="p">(</span><span class="nx">persister</span><span class="p">.</span><span class="nf">ReadRaftState</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshotData</span> <span class="p">=</span> <span class="nx">persister</span><span class="p">.</span><span class="nx">snapshot</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// start ticker goroutine to start elections
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">ticker</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">go</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">ApplyCommand</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="nx">rf</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<hr>
<h2 id="持久化"><strong>持久化</strong></h2>
<p><strong>由于我们现在都是保存在内存中的，那么断电即失，因此我们肯定是需要持久化保存起来的，比如说写入磁盘中。由于lab测试方便，官方提供的是一个类<code>Persister</code>来模拟持久化存储的容器，实际上这部分可以换成直接对磁盘的写入或者通过<code>RockDB</code>之类的进行持久化。</strong></p>
<h3 id="持久化数据"><strong>持久化数据</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">persist</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your code here (2C).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Example:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// w := new(bytes.Buffer)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// e := labgob.NewEncoder(w)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// e.Encode(rf.xxx)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// e.Encode(rf.yyy)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// data := w.Bytes()
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// rf.persister.SaveRaftState(data)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">w</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">e</span> <span class="o">:=</span> <span class="nx">labgob</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode currentTerm error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码voteFor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode voteFor error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码log[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode logEntries[] error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">data</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//保存持久化状态
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">persister</span><span class="p">.</span><span class="nf">SaveRaftState</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>在我们对如上的数据进行更改的时候，都需要进行一次持久化</strong></p>
<hr>
<h3 id="读取持久化数据"><strong>读取持久化数据</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">readPersist</span><span class="p">(</span><span class="nx">data</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">data</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nb">len</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">&lt;</span> <span class="mi">1</span> <span class="p">{</span> <span class="c1">// bootstrap without any state?
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your code here (2C).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// Example:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// r := bytes.NewBuffer(data)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// d := labgob.NewDecoder(r)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// var xxx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// var yyy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// if d.Decode(&amp;xxx) != nil ||
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//    d.Decode(&amp;yyy) != nil {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//   error...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// } else {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//   rf.xxx = xxx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">//   rf.yyy = yyy
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">r</span> <span class="o">:=</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewBuffer</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">d</span> <span class="o">:=</span> <span class="nx">labgob</span><span class="p">.</span><span class="nf">NewDecoder</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">currentTerm</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">voteFor</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">   <span class="kd">var</span> <span class="nx">logEntries</span> <span class="p">[]</span><span class="nx">LogEntry</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">currentTerm</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">voteFor</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">||</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">logEntries</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: decode error\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="nx">voteFor</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nx">logEntries</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>我们初始化的时候，需要从persister中读取持久化数据</strong></p>
<hr>
<hr>
<h2 id="快照"><strong>快照</strong></h2>
<p><strong>我们的日志肯定是不可以持续的增长下去的，因为当我们日志数量达到很大的时候，比如说我们的日志数据已经达到了几千万条的时候，我们和一个还没有多少数据的跟随者进行同步的话，需要将这些日志全部发送，其实是十分浪费资源和时间的。</strong></p>
<p><strong>那么我们其实可以使用快照，也就是对领袖某一个时刻它的状态机的数据进行保存，然后将这个快照发送给那些很落后的节点进行快速的同步，同时由于快照已经记录此时的所有必要数据，那么我们可以将这些日志删除，避免日志无限度的增长下去。</strong></p>
<h3 id="论文解析"><strong>论文解析</strong></h3>
<p><strong>论文中的<code>Figure 13</code>是安装快照的RPC的参数和实现。</strong></p>
<p><strong><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png" title="image-20220319210923396" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png" data-sub-html="<h2>安装快照RPC</h2><p>image-20220319210923396</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319210923396.png" />
    </a><figcaption class="image-caption">安装快照RPC</figcaption>
    </figure></strong></p>
<blockquote>
<p><strong>由领袖调用，用于发送一个快照的分块给跟随者。领袖领袖按照顺序发送分块</strong></p>
</blockquote>
<p><strong>参数：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>领袖的任期</strong></td>
</tr>
<tr>
<td><strong>leaderId</strong></td>
<td><strong>领袖的id，便于跟随者用于重定向客户端的请求</strong></td>
</tr>
<tr>
<td><strong>lastIncludedIndex</strong></td>
<td><strong>快照取代的所有的日志中最后一个日志的索引</strong></td>
</tr>
<tr>
<td><strong>lastIncludedTerm</strong></td>
<td><strong>lastIncludedIndex处的日志的任期</strong></td>
</tr>
<tr>
<td><strong>offset</strong></td>
<td><strong>该分块在快照文件中的字节偏移量</strong></td>
</tr>
<tr>
<td><strong>data[]</strong></td>
<td><strong>从offset开始的分块的纯字节数据</strong></td>
</tr>
<tr>
<td><strong>done</strong></td>
<td><strong>如果是最后一个分块则为true</strong></td>
</tr>
</tbody>
</table>
<p><strong>结果：</strong></p>
<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>term</strong></td>
<td><strong>服务器的currentTerm，用于领袖更新自己的任期</strong></td>
</tr>
</tbody>
</table>
<p><strong>接收者实现：</strong></p>
<ol>
<li><strong>如果<code>term</code> &lt; <code>currentTerm</code>则立马回复。</strong></li>
<li><strong>如果是第一个分块则创建一个新的快照文件。(<code>offset</code>为0)</strong></li>
<li><strong>在给定的<code>offset</code>处开始写入数据。</strong></li>
<li><strong>如果<code>done</code>不为true，那么回复然后等待更多的数据分块传来。</strong></li>
<li><strong>保存快照文件，丢弃任何比<code>lastIncludedIndex</code>小的快照或者部分快照。</strong></li>
<li><strong>如果存在一个日志和快照最后包含的日志有着一样的索引和任期，那么保留这个日志以及其以后的日志，并回复。</strong></li>
<li><strong>丢弃所有日志。</strong></li>
<li><strong>使用快照的内容重置状态机。(以及加载快照的集群配置)</strong></li>
</ol>
<hr>
<h3 id="实现快照"><strong>实现快照</strong></h3>
<p><strong>但是我们lab不需要实现这么复杂的快照，因此对其进行了简化。</strong></p>
<p><strong>我们一次直接发送一整个快照过去。</strong></p>
<p><strong>调用流程是：</strong></p>
<ul>
<li><strong>状态机发现自己的目前的存储数据过大，那么就保存当前的状态机必须状态以及日志和Raft的必须状态到快照中。然后通知Raft对自己的日志进行丢弃，也就是调用Raft的<code>Snapshot()</code>。(日志数组第一位要么为空占位日志，也就是一次快照都没进行的时候日志数组下标为0位置的日志，要么为快照后索引为<code>lastIncludeIndex</code>的日志)</strong></li>
<li><strong>当领袖发送<code>ApppendEntries RPC</code>的时候，发现需要跟随者的<code>nextIndex</code> &lt;= 日志数组中第一个日志的索引的时候，也就是需要发送的日志已经被丢弃了，那么就调用<code>InstallSnapshot()</code>来安装快照。</strong></li>
<li><strong>当跟随者接收到领袖发来的快照的时候，若快照是正确的，那么就接收，并通过<code>applyCh</code>传递给状态机。</strong></li>
<li><strong>状态机接收到安装快照的请求，进行快照数据的应用，并且通知Raft去更新到该快照。也就是调用Raft的<code>CondInstallSnapshot()</code>。</strong></li>
<li><strong>Raft被调用<code>CondInstallSnapshot()</code>之后，对响应的日志进行丢弃。</strong></li>
</ul>
<p><strong><figure><a class="lightgallery" href="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png" title="image-20220319213012992" data-thumbnail="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png" data-sub-html="<h2>交互流程图</h2><p>image-20220319213012992</p>">
        <img
            class="lazyload"
            src="/svg/loading.min.svg"
            data-src="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png"
            data-srcset="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png 1.5x, https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png 2x"
            data-sizes="auto"
            alt="https://ther1sing3un-personal-resource.oss-cn-beijing.aliyuncs.com/typora/images/image-20220319213012992.png" />
    </a><figcaption class="image-caption">交互流程图</figcaption>
    </figure></strong></p>
<hr>
<h3 id="实现installsnapshot"><strong>实现InstallSnapshot</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// InstallSnapshotArgs 快照安装RPC的参数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">InstallSnapshotArgs</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Term</span>              <span class="kt">int</span>    <span class="c1">//leader的任期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">LeaderId</span>          <span class="kt">int</span>    <span class="c1">//leader的id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">LastIncludedIndex</span> <span class="kt">int</span>    <span class="c1">//快照中包含的最后一个日志条目的index
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">LastIncludedTerm</span>  <span class="kt">int</span>    <span class="c1">//快照中包含的最后一个日志条目的term
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">Data</span>              <span class="p">[]</span><span class="kt">byte</span> <span class="c1">//快照数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// InstallSnapshotReply 快照安装的返回值
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">type</span> <span class="nx">InstallSnapshotReply</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Term</span> <span class="kt">int</span> <span class="c1">//接收者的currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">// InstallSnapshot 快照安装的RPC
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">InstallSnapshot</span><span class="p">(</span><span class="nx">args</span> <span class="o">*</span><span class="nx">InstallSnapshotArgs</span><span class="p">,</span> <span class="nx">reply</span> <span class="o">*</span><span class="nx">InstallSnapshotReply</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">reply</span><span class="p">.</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span>
</span></span><span class="line"><span class="cl">   <span class="p">}()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//1.判断参数中的term是否小于currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//该快照为旧的,直接丢弃并返回
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 接收到leader[%d]的快照:lastLogIndex[%d],lastLogTerm[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LeaderId</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//2.若参数中term大于currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span> <span class="p">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span> <span class="p">=</span> <span class="o">-</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nf">persist</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//3.重置选举时间
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">resetElectTimer</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//4.转变为follower
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">toFollower</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//5.若快照过期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: leader[%d]的快照:lastLogIndex=[%d],lastLogTerm=[%d]已过期,commitIndex=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LeaderId</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//5.通过applyCh传至service
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">applyMsg</span> <span class="o">:=</span> <span class="nx">ApplyMsg</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">SnapshotValid</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">Snapshot</span><span class="p">:</span>      <span class="nx">args</span><span class="p">.</span><span class="nx">Data</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">SnapshotIndex</span><span class="p">:</span> <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedIndex</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nx">SnapshotTerm</span><span class="p">:</span>  <span class="nx">args</span><span class="p">.</span><span class="nx">LastIncludedTerm</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="nx">msg</span> <span class="nx">ApplyMsg</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">applyCh</span> <span class="o">&lt;-</span> <span class="nx">msg</span>
</span></span><span class="line"><span class="cl">   <span class="p">}(</span><span class="nx">applyMsg</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>异步传递msg，避免持有锁的时候阻塞，导致死锁了</strong></p>
<hr>
<h3 id="实现snapshot"><strong>实现Snapshot</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">Snapshot</span><span class="p">(</span><span class="nx">index</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Your code here (2D).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">index</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span> <span class="o">||</span> <span class="nx">index</span> <span class="p">&lt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="o">||</span> <span class="nx">index</span> <span class="p">&gt;</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//1.获取需要压缩末尾日志的数组内索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">realIndex</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">lastLogEntry</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="nx">realIndex</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 安装snapshot:lastIncludedIndex=[%d],lastIncludedTerm=[%d];commitIndex=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Term</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//2.清除log中[1,realIndex]之间的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="nx">realIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//3.保存三项快照数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshotData</span> <span class="p">=</span> <span class="nx">snapshot</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//4.更改日志占位节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="p">=</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Index</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Term</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//5.持久化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">persistStateAndSnapshot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 安装snapshot:lastIncludedIndex=[%d],lastIncludedTerm=[%d] 成功\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Index</span><span class="p">,</span> <span class="nx">lastLogEntry</span><span class="p">.</span><span class="nx">Term</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="实现condinstallsnapshot"><strong>实现CondInstallSnapshot</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">CondInstallSnapshot</span><span class="p">(</span><span class="nx">lastIncludedTerm</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">lastIncludedIndex</span> <span class="kt">int</span><span class="p">,</span> <span class="nx">snapshot</span> <span class="p">[]</span><span class="kt">byte</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">   <span class="c1">// Your code here (2D).
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="k">defer</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 安装snapshot:lastIncludedIndex=[%d],lastIncludedTerm=[%d];commitIndex=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastIncludedIndex</span><span class="p">,</span> <span class="nx">lastIncludedTerm</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//1.判断快照是否过期
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">if</span> <span class="nx">lastIncludedIndex</span> <span class="o">&lt;=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]:安装 snapshot:lastIncludedIndex=[%d],lastIncludedTerm=[%d]已过期,安装失败\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastIncludedIndex</span><span class="p">,</span> <span class="nx">lastIncludedTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">false</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">lastLog</span><span class="p">().</span><span class="nx">Index</span> <span class="p">&lt;</span> <span class="nx">lastIncludedIndex</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//若快照的最后一个log比当前最新的log还晚,那么清空log中除了0位的log
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[:</span><span class="mi">1</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//清除log中[1,realIndex]之间的数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nx">realIndex</span> <span class="o">:=</span> <span class="nx">rf</span><span class="p">.</span><span class="nf">binaryFindRealIndexInArrayByIndex</span><span class="p">(</span><span class="nx">lastIncludedIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="nx">realIndex</span><span class="o">+</span><span class="mi">1</span><span class="p">:]</span><span class="o">...</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//3.保存快照数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshotData</span> <span class="p">=</span> <span class="nx">snapshot</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//4.更改日志占位节点
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Index</span> <span class="p">=</span> <span class="nx">lastIncludedIndex</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">Term</span> <span class="p">=</span> <span class="nx">lastIncludedTerm</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//5.更新commitIndex和lastAppliedIndex
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span> <span class="p">=</span> <span class="nx">lastIncludedIndex</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">lastApplied</span> <span class="p">=</span> <span class="nx">lastIncludedIndex</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//6.持久化
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">rf</span><span class="p">.</span><span class="nf">persistStateAndSnapshot</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: 安装snapshot:lastIncludedIndex=[%d],lastIncludedTerm=[%d] 成功;commitIndex=[%d]\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">lastIncludedIndex</span><span class="p">,</span> <span class="nx">lastIncludedTerm</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">commitIndex</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">return</span> <span class="kc">true</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="实现快照持久化"><strong>实现快照持久化</strong></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="c1">//保存raft状态和snapshot
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">rf</span> <span class="o">*</span><span class="nx">Raft</span><span class="p">)</span> <span class="nf">persistStateAndSnapshot</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">w</span> <span class="o">:=</span> <span class="nb">new</span><span class="p">(</span><span class="nx">bytes</span><span class="p">.</span><span class="nx">Buffer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="nx">e</span> <span class="o">:=</span> <span class="nx">labgob</span><span class="p">.</span><span class="nf">NewEncoder</span><span class="p">(</span><span class="nx">w</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码currentTerm
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode currentTerm error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码voteFor
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">voteFor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode voteFor error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//编码log[]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">err</span> <span class="p">=</span> <span class="nx">e</span><span class="p">.</span><span class="nf">Encode</span><span class="p">(</span><span class="nx">rf</span><span class="p">.</span><span class="nx">logEntries</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="nf">DPrintf</span><span class="p">(</span><span class="s">&#34;id[%d].state[%v].term[%d]: encode logEntries[] error: %v\n&#34;</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">me</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">currentTerm</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="nx">data</span> <span class="o">:=</span> <span class="nx">w</span><span class="p">.</span><span class="nf">Bytes</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   <span class="nx">rf</span><span class="p">.</span><span class="nx">persister</span><span class="p">.</span><span class="nf">SaveStateAndSnapshot</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">rf</span><span class="p">.</span><span class="nx">snapshotData</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><hr>
<h3 id="实现发送installsnap"><strong>实现发送InstallSnap</strong></h3>
<p><strong>这一步就是在日志模块中的<code>HandleAppendEntries|()</code>中已经实现，只需要发送的时候判断一下是否需要发送快照即可。</strong></p>
<hr>
<h2 id="总结"><strong>总结</strong></h2>
<p><strong>Lab2算是该课程中最难的一个Lab了，个人前前后后做了由半个月多才达到bugfree(自测2000次无fail)。接下来会继续更新Lab3以及Lab4的实现文档。</strong></p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-03-18</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span>
                            <a class="link-to-markdown" href="/mit-6.824-lab2/index.md" target="_blank">阅读原始文档</a>
                        </span></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/">分布式系统</a>,&nbsp;<a href="/tags/raft/">Raft</a>,&nbsp;<a href="/tags/golang/">Golang</a>,&nbsp;<a href="/tags/mit-6.824/">MIT-6.824</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/kv%E5%B1%82%E7%9A%84read%E8%AF%B7%E6%B1%82%E4%BC%98%E5%8C%96/" class="prev" rel="prev" title="KV层的Read请求优化"><i class="fas fa-angle-left fa-fw"></i>KV层的Read请求优化</a>
            <a href="/mit-6.824-lab%E6%8C%87%E5%AF%BC%E7%BF%BB%E8%AF%91/" class="next" rel="next" title="MIT 6.824 Lab指导翻译">MIT 6.824 Lab指导翻译<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="/" target="_blank">TheR1sing3un</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">粤ICP备2021124507号</span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="回到顶部">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/lightgallery.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script type="text/javascript" src="/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.stemmer.support.min.js"></script><script type="text/javascript" src="/lib/lunr/lunr.zh.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js"></script><script type="text/javascript" src="/lib/katex/auto-render.min.js"></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js"></script><script type="text/javascript" src="/lib/katex/mhchem.min.js"></script><script type="text/javascript" src="/lib/cookieconsent/cookieconsent.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验."},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"data":{"id-1":"TheR1sing3un的个人博客","id-2":"TheR1sing3un的个人博客"},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"},"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-1":["id-1"],"id-2":["id-2"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
